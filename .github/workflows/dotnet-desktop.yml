name: .NET Build

on:

  pull_request

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find solution file dynamically
      id: find_solution
      shell: bash
      run: |
        SOL=$(find . -maxdepth 3 -name "*.sln" | head -n 1)
        echo "solution=$SOL" >> $GITHUB_OUTPUT
        echo "Found solution: $SOL"

    - name: Setup .NET 8.0 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore "${{ steps.find_solution.outputs.solution }}"

    - name: Build
      run: dotnet build "${{ steps.find_solution.outputs.solution }}" --configuration Release --no-restore

    - name: Run tests (if exist)
      shell: bash
      run: |
        TESTS=$(find . -type f -name "*.csproj" | grep -i "test" || true)
        if [ -n "$TESTS" ]; then
          for t in $TESTS; do
            echo "Running tests in $t"
            dotnet test "$t" --no-build --configuration Release
          done
        else
          echo "No test projects found, skipping."
        fi

    - name: Publish Web API
      shell: bash
      run: |
        API=$(find . -type f -name "WIS.WebApi.Host.csproj" | head -n 1)
        if [ -n "$API" ]; then
          echo "Publishing $API"
          dotnet publish "$API" --configuration Release --output ./publish
        else
          echo "WIS.WebApi.Host.csproj not found!"
          exit 1
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: publish
        path: publish
